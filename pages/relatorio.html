<div id="relatorio">
    <div class="row">
        <div class="col col-12 mb-5 alert alert-light">
            <form name="filtra-relatorio" id="filtra-relatorio">
                <div class="form-row filtros align-items-end">
                    <div class="col col-md-3">
                        <div class="form-group">
                            <label id="lbl_select-produtos" for="select-produtos">Produtos</label>
                            <select class="form-control input-lg" validate="required" name="idProduto" id="select-produtos">
							</select>
                        </div>
                    </div>
                    <div class="col col-md-3">
                        <div class="form-group">
                            <label id="lbl_DataRange" for="reportrange">Período</label>
                            <div id="reportrange" class="rounded bg-white p-1 border" style="background: #fff; cursor: pointer; width: 100%">
                                <i class="fa fa-calendar-alt"></i>&nbsp;
                                <span></span> <i class="fa fa-caret-down"></i>
                            </div>
                            <input type="hidden" validate="required" id="DataRange" name="DataRange">
                        </div>
                    </div>
                    <div class="col col-md-3">
                        <div class="form-group">
                            <button type="submit" class="form-control btn btn-light">Buscar</button>
                        </div>
                    </div>
                </div>
        </div>
        </form>
    </div>
    <div class="col col-12">
        <div class="table-responsive">
            <table class="table table-striped" data-detail-view="true">
                <thead class="thead-light">
                    <tr>
                        <th scope="col">Nome</th>
                        <th scope="col">Telefone</th>
                        <th scope="col">Celular</th>
                        <th scope="col">E-mail</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody class="table-load">
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

<div class="modal" tabindex="-1" role="dialog" id="detalhe">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhe</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
            </div>
            <div class="modal-body">

            </div>
        </div>
    </div>
</div>

<script>
    Relatorio = function() {
        $this = this;
        var storeRelatorio = {};

        RelatorioMethods = {
            initialize: function() {
                // jQuery.gDisplay.loadStart();
                this.onLoad();
            },
            onLoad: function() {
                $('.titulo_pagina h1').text('Relatório');

                // Date ranger
                var start = moment().subtract(29, 'days');
                var end = moment();

                function cb(start, end) {
                    $('#reportrange span').html(start.format('DD/MM/YYYY') + ' - ' + end.format(
                        'DD/MM/YYYY'));
                    $('input[name=DataRange]').val(start.format('YYYY-MM-DD') + '|' + end.format(
                        'YYYY-MM-DD'));
                }

                $('#reportrange').daterangepicker({
                    // showDropdowns: true,
                    format: "DD/MM/YYYY",
                    startDate: start,
                    endDate: end,
                    maxDate: end,
                    ranges: {
                        'Hoje': [moment(), moment()],
                        'Antem': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        'Últimos 7 dias': [moment().subtract(6, 'days'), moment()],
                        'Últimos 30 dias': [moment().subtract(29, 'days'), moment()],
                        'Mês atual': [moment().startOf('month'), moment().endOf('month')],
                        'Mês anterior': [moment().subtract(1, 'month').startOf('month'), moment()
                            .subtract(1, 'month').endOf('month')
                        ]
                    },
                    locale: {
                        format: "DD/MM/YYYY",
                        separator: " - ",
                        applyLabel: "Aplicar",
                        cancelLabel: "Cancelar",
                        fromLabel: "De",
                        toLabel: "Para",
                        customRangeLabel: "Personalizar",
                        startDate: start,
                        maxDate: end,
                        daysOfWeek: ['Do', 'Se', 'Te', 'Qu', 'Qu', 'Se', 'Sa'],
                        monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                            'Julho', 'Agosto', 'Setembro', 'Outubro',
                            'Novembro', 'Dezembro'
                        ],
                        firstDay: 1,
                        showWeekNumbers: false,
                        buttonClasses: ['dark-gray'],
                        applyClass: 'blue'

                    },
                    alwaysShowCalendars: false,
                    autoUpdateInput: false
                }, cb);



                cb(start, end);
                // Select Produtos
                var selectData = {
                    id: '',
                    text: 'Selecione um produto',
                    selectDefault: false,
                    selected: true
                };
                var newOption = new Option(selectData.text, selectData.id, selectData.selectDefault,
                    selectData.selected);
                $('#select-produtos').append(newOption);
                var listaProdutos = jQuery.lockrStorage.get('produtos');
                if (listaProdutos) {
                    $.each(listaProdutos, function(i, item) {
                        if (item.Titulo != 'Regula') {
                            var newOption = new Option(item.Titulo, item.id, false, false);
                            $('#select-produtos').append(newOption);
                        }
                    });
                }
                $('#select-produtos').select2({
                    theme: "bootstrap"
                });

                // Busca pelos filtros
                $('form[name=filtra-relatorio]').submit(function(e) {
                    e.preventDefault();
                    var usuario = jQuery.lockrStorage.get('usuario');
                    var dados = $(this).serializeObject();
                    console.log($('form[name=filtra-relatorio]').gValidate());
                    if (sizeObj(usuario) > 0 && $('form[name=filtra-relatorio]').gValidate()) {
                        var parceiro = usuario.Parceiro.id;
                        var DataRange = dados.DataRange.split('|');
                        var url =
                            'http://integracaogtsis.tempsite.ws/api/Indicacoes/Supercredito/Parceiros/' +
                            parceiro;
                        var jsonUrl = {
                            idProduto: dados.idProduto,
                            DataInicial: DataRange[0],
                            DataFinal: DataRange[1],
                            TamanhoPagina: 10,
                            idUsuarioParceiro: usuario.id,
                            NumeroPagina: 1
                        }


                        jQuery.gApi.exec('GET', url + '?' + jQuery.param(jsonUrl), {},

                            function(json) {
                                storeRelatorio = json.Data;
                                var htmlTabela = RelatorioMethods.buildTable(json.Data);
                                $('.table-load').html(htmlTabela);
                            },
                            function(err) {
                                alerta('Erro', err.responseJSON.Message.Error, 'error');

                            });
                    }
                    return false;
                });

                $(document).on('click', 'a.detalhe', function(e) {
                    e.preventDefault();
                    var id = $(this).data('id');
                    RelatorioMethods.buildModalDetail(id);
                    return false;
                });

            },
            buildTable: function(data) {
                var html = "";
                console.log(data);
                if (data == null || data == undefined) {
                    html += '<tr>';
                    html += '<td scope="row" colspan="5">';
                    html += '<p class="text-center text-secondary"> Nenhum resultado encontrado! </p>';
                    html += '</td>';
                    html += '</tr>';
                }
                $.each(data, function(i, item) {
                    html += '<tr>';
                    html +=
                        '<td scope="row"><a href="" class="detalhe btn btn-link" data-id="' + item.id +
                        '">' +
                        checkNull(item
                            .Cliente.Nome) +
                        '</a></td>';
                    html += '<td>' + checkNull(item.Cliente.Telefone) + '</td>';
                    html += '<td>' + checkNull(item.Cliente.Celular) + '</td>';
                    html += '<td>' + checkNull(item.Cliente.Email) + '</td>';
                    html += '<td><span class="badge badge-pill badge-primary">' + checkNull(item
                        .StatusProspect
                        .Descricao) + '</span></td>';
                    html +='<span id="">teste</span>';
                    html += '</tr>';
                });
                return html;
            },
            buildModalDetail: function(id) {
                var detail = RelatorioMethods.filtraIndicacao(id);
                if (detail) {
                    var html = '';
                    html += '<div class="container-fluid">';
                    html += '<div class="row">';
                    html += addInput('Nome', {
                        type: "text",
                        value: detail.Cliente.Nome,
                        disabled: true
                    }, 'col-md-5');
                    html += addInput(((detail.Cliente.PJ) ? 'CNPJ' : 'CPF'), {
                        type: "text",
                        value: checkNull(detail.Cliente.CpfCnpj),
                        disabled: true
                    }, 'col-md-4');
                    html += addInput('Sexo', {
                        type: "text",
                        value: (checkNull(detail.Cliente.Sexo) == 'M')? 'Masculino' : 'Feminino',
                        disabled: true
                    }, 'col-md-3');
                    html += addInput('Telefone', {
                        type: "text",
                        value: checkNull(detail.Cliente.Telefone),
                        disabled: true
                    }, 'col-md-4');
                    html += addInput('Celular', {
                        type: "text",
                        value: checkNull(detail.Cliente.Celular),
                        disabled: true
                    }, 'col-md-4');
                    html += '';
                    html += '</div>';
                    html += '</div>';
                    $('#detalhe .modal-body').empty().html(html);
                    $('#detalhe').modal('show');
                }
            },
            filtraIndicacao(id) {
                var ret = null;
                $.each(storeRelatorio, function(i, item) {
                    if (item.id == id) {
                        ret = item;
                    }
                });
                return ret;
            }


        }
        RelatorioMethods.initialize();
    };

    $(function() {
        Relatorio();
    });
</script>

<style>

</style>